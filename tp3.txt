TrÃ¨s bien â€” on remet la table proprement, en franÃ§ais, avec un fil clair et sans surcharge. Voici les exercices 3.1 Ã  3.3 expliquÃ©s simplement et proprement.

---

# **Exercice 3.1 â€” PrÃ©paration des machines virtuelles**

On doit partir de ta VM Gentoo dâ€™origine (fonctionnelle), puis en crÃ©er deux clones :

* **client1**
* **router**

### **Configuration rÃ©seau dans VirtualBox**

### **Machine : router**

Elle doit avoir **deux interfaces** :

1. **eth0 : NAT (accÃ¨s Internet)**

   * Câ€™est lâ€™interface qui permet au routeur de parler au monde extÃ©rieur.
   * Dans VirtualBox :

     * *ParamÃ¨tres â†’ RÃ©seau â†’ Carte 1 â†’ Mode dâ€™accÃ¨s rÃ©seau : NAT*

2. **eth1 : rÃ©seau interne "istycorp"**

   * Câ€™est le rÃ©seau local interne entre le routeur et les clients.
   * Dans VirtualBox :

     * *ParamÃ¨tres â†’ RÃ©seau â†’ Carte 2 â†’ Mode dâ€™accÃ¨s rÃ©seau : RÃ©seau interne*
     * Nom du rÃ©seau interne : **istycorp**

---

### **Machine : client1**

Elle doit avoir **une seule interface** :

* **eth0 : rÃ©seau interne "istycorp"**

  * MÃªme configuration que lâ€™interface interne du routeur.
  * Dans VirtualBox :

    * *ParamÃ¨tres â†’ RÃ©seau â†’ Carte 1 â†’ Mode dâ€™accÃ¨s rÃ©seau : RÃ©seau interne*
    * Nom : **istycorp**

---

# **Exercice 3.2 â€” Pourquoi ne pas connecter directement les clients Ã  Internet ?**

Minimum **trois raisons**, toutes fondamentales :

### **1. SÃ©curitÃ©**

Les clients seraient exposÃ©s directement aux attaques :

* scans de ports,
* malware,
* exploitation de failles,
* etc.

Un routeur fait office de barriÃ¨re, NAT, firewall, bouclier.

### **2. Gestion centralisÃ©e**

Le routeur :

* distribue les IP (DHCP),
* gÃ¨re les rÃ¨gles de pare-feu,
* fait du NAT,
* peut enregistrer du trafic,
* applique des politiques rÃ©seau.

Sans routeur, chaque machine serait livrÃ©e Ã  elle-mÃªme.

### **3. Ã‰conomie dâ€™adresses IP publiques**

Sans routeur, il faudrait une adresse IP **publique** par machine.
On utilise le NAT pour partager **une seule IP** vers Internet.

### Bonus (pas obligatoire mais juste)

* ContrÃ´le du trafic sortant
* ContrÃ´le de la bande passante
* Isolation entre machines

---

# **Exercice 3.3 â€” RÃ´le du serveur DHCP et des serveurs DNS**

### **Serveur DHCP**

Il attribue automatiquement aux clients :

* une adresse IP,
* un masque de rÃ©seau,
* une passerelle par dÃ©faut,
* des DNS.

Autrement dit :
**il automatise la configuration rÃ©seau des machines du LAN.**

Sans DHCP, chaque machine doit Ãªtre configurÃ©e Ã  la main.

---

### **Serveur DNS**

Il traduit les noms de domaine en adresses IP.

Exemple :
`www.google.com` â†’ `142.250.150.36`

Sans DNS, Internet serait une mer de chiffres inhospitaliers, un peu comme une ville oÃ¹ les rues nâ€™auraient plus de noms mais seulement des coordonnÃ©es GPS.

---




TrÃ¨s bien, reprenons pas Ã  pas la configuration manuelle et les exercices que tu cites ğŸ‘‡  

---

### ğŸ”‘ Exercice 3.4 â€“ Installation SSH sur le routeur
- Installe le serveur SSH (par exemple `openssh` sur Gentoo) :  
  ```bash
  emerge --ask net-misc/openssh
  rc-update add sshd default
  /etc/init.d/sshd start
  ```
- Dans VirtualBox, configure une **redirection de port** sur lâ€™interface NAT :  
  - Exemple : rediriger le port hÃ´te `2222` vers le port invitÃ© `22`.  
  - Tu pourras ensuite te connecter avec :  
    ```bash
    ssh -p 2222 user@localhost
    ```

---

### ğŸ–¥ï¸ Exercice 3.5 â€“ Nom dâ€™hÃ´te et domaine local
- Changer le nom dâ€™hÃ´te du client :  
  ```bash
  hostnamectl set-hostname client1
  ```
- VÃ©rifier le domaine local :  
  ```bash
  dnsdomainname
  ```
- Tu peux aussi vÃ©rifier dans `/etc/hosts` et `/etc/hostname` que le nom est cohÃ©rent.

---

### ğŸŒ Exercice 3.6 â€“ Configuration IP manuelle
Sur le **routeur** :
```bash
ifconfig eth1 192.168.0.1 netmask 255.255.255.0 up
```
Sur le **client1** :
```bash
ifconfig eth0 192.168.0.2 netmask 255.255.255.0 up
```
- Teste la connectivitÃ© :  
  ```bash
  ping 192.168.0.1   # depuis client1
  ping 192.168.0.2   # depuis routeur
  ```
- VÃ©rifie les tables de routage :  
  ```bash
  route -n
  ```
  ğŸ‘‰ Tu verras que chaque machine connaÃ®t son rÃ©seau local (`192.168.0.0/24`) mais **le client nâ€™a pas encore de passerelle vers Internet**.

---

### ğŸ“¡ Exercice 3.7 â€“ Configuration DNS
- Sur le client, Ã©dite `/etc/resolv.conf` :  
  ```bash
  nameserver 8.8.8.8
  nameserver 192.168.0.1
  ```
- Teste une rÃ©solution :  
  ```bash
  nslookup google.com
  ```
- Pourquoi Ã§a ne marche pas ?  
  - Parce que le client nâ€™a pas encore de **passerelle par dÃ©faut** vers Internet.  
  - Le routeur nâ€™a pas encore activÃ© le **routage** ni le **NAT**.  
  - RÃ©sultat : les paquets sortants du client ne savent pas comment atteindre Internet.

---

### ğŸ”„ Exercice 3.8 â€“ Objectif du NAT
- **NAT (Network Address Translation)** permet de partager une seule IP publique entre plusieurs machines internes.  
- Il traduit les adresses privÃ©es (192.168.x.x) en une adresse publique unique.  
- Avantage : Ã©conomie dâ€™IP et sÃ©curitÃ© (les machines internes ne sont pas directement exposÃ©es).  
- Avec **IPv6**, ce problÃ¨me est largement rÃ©duit car lâ€™espace dâ€™adressage est quasi illimitÃ© â†’ chaque machine peut avoir une adresse publique unique sans besoin de NAT.

---

### âš™ï¸ Exercice 3.9 â€“ Activer le routage
- Dans `/etc/sysctl.conf`, ajoute ou dÃ©commente :  
  ```
  net.ipv4.ip_forward = 1
  ```
- Sans redÃ©marrer, active immÃ©diatement :  
  ```bash
  sysctl -w net.ipv4.ip_forward=1
  echo 1 > /proc/sys/net/ipv4/ip_forward
  ```
ğŸ‘‰ Cela permet au routeur de **transfÃ©rer les paquets entre ses deux interfaces** (interne â†” externe).  

---
Parfait, tu arrives Ã  lâ€™Ã©tape clÃ© : activer le **NAT** sur ton routeur pour que les clients du rÃ©seau interne puissent accÃ©der Ã  Internet via lâ€™interface NAT du routeur.  

---

### âš™ï¸ Exercice 3.10 â€“ Activer le support du NAT
La commande que tu cites est correcte, mais dÃ©taillons son rÃ´le :

```bash
iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE
```

- **`-t nat`** : on agit sur la table NAT (Network Address Translation).  
- **`-A POSTROUTING`** : on ajoute une rÃ¨gle dans la chaÃ®ne POSTROUTING (appliquÃ©e aprÃ¨s la dÃ©cision de routage).  
- **`-s 192.168.0.0/24`** : cette rÃ¨gle sâ€™applique aux paquets provenant du rÃ©seau interne `192.168.0.x`.  
- **`-o eth0`** : les paquets sortant par lâ€™interface externe (ici `eth0`, reliÃ©e Ã  Internet via NAT).  
- **`-j MASQUERADE`** : on applique le masquage, câ€™est-Ã -dire que les adresses IP privÃ©es sont remplacÃ©es par lâ€™adresse publique du routeur.  

ğŸ‘‰ RÃ©sultat : les clients internes apparaissent sur Internet comme sâ€™ils Ã©taient le routeur lui-mÃªme.

---

### ğŸ” VÃ©rification
1. Active le routage (si ce nâ€™est pas dÃ©jÃ  fait) :  
   ```bash
   sysctl -w net.ipv4.ip_forward=1
   ```
2. VÃ©rifie les rÃ¨gles NAT :  
   ```bash
   iptables -t nat -L -n -v
   ```
3. Depuis **client1**, teste :  
   ```bash
   ping 8.8.8.8
   ```
   Si Ã§a marche, le NAT est opÃ©rationnel.  
4. Teste ensuite la rÃ©solution DNS (si `/etc/resolv.conf` est bien configurÃ©) :  
   ```bash
   ping google.com
   ```

---

### ğŸ§© Points pÃ©dagogiques
- Le NAT est indispensable en IPv4 car lâ€™espace dâ€™adressage est limitÃ©.  
- En IPv6, chaque machine pourrait avoir une adresse publique unique â†’ NAT devient inutile.  
- Le routeur joue donc le rÃ´le de **passerelle** et de **traducteur dâ€™adresses**.

---
TrÃ¨s bien, poursuivons avec les exercices 3.11 Ã  3.14 ğŸ‘‡  

---

### ğŸ› ï¸ Exercice 3.11 â€“ Passerelle par dÃ©faut sur le client
Sur **client1**, ajoute une route par dÃ©faut vers le routeur :
```bash
route add default gw 192.168.0.1 eth0
```
ğŸ‘‰ Cela signifie que **tous les paquets destinÃ©s Ã  Internet** (hors rÃ©seau local) seront envoyÃ©s au routeur, qui se charge de les traduire via NAT et de les transmettre vers lâ€™extÃ©rieur.

---

### ğŸŒ Exercice 3.12 â€“ Tester la connexion Internet
- Depuis le client, teste :
  ```bash
  ping 8.8.8.8
  traceroute 8.8.8.8
  ```
  Tu verras que le premier saut est `192.168.0.1` (le routeur), puis les diffÃ©rents routeurs intermÃ©diaires jusquâ€™Ã  Google.
- Sur le routeur, tu peux observer le trafic avec :
  ```bash
  tcpdump -i eth0
  ```
  ğŸ‘‰ Tu verras les paquets sortants du client, traduits par le NAT.

---

### ğŸ”’ Exercice 3.13 â€“ SÃ©curitÃ© des protocoles non chiffrÃ©s
Avec des outils comme **tcpdump** ou **Wireshark**, tu peux capturer et lire :
- Les requÃªtes HTTP (URL, paramÃ¨tres, cookies).
- Les rÃ©ponses HTTP (contenu en clair).
- Les identifiants transmis en clair (login/password si non HTTPS).
ğŸ‘‰ Remarque : **les communications non chiffrÃ©es sont vulnÃ©rables Ã  lâ€™interception et au vol de donnÃ©es**.  
Câ€™est pourquoi aujourdâ€™hui on privilÃ©gie **HTTPS, SSH, TLS** pour garantir confidentialitÃ© et intÃ©gritÃ©.

---

### ğŸ“‚ Exercice 3.14 â€“ FTP en mode actif
- En **mode actif FTP**, le client ouvre une connexion vers le port 21 du serveur, puis le serveur tente de se connecter **en retour** vers un port alÃ©atoire du client pour transfÃ©rer les donnÃ©es.
- ProblÃ¨me : derriÃ¨re un routeur NAT, le client nâ€™est pas directement accessible depuis Internet â†’ le serveur ne peut pas initier la connexion retour.
- RÃ©sultat : le mode actif Ã©choue.  
ğŸ‘‰ Solution : utiliser le **mode passif FTP**, oÃ¹ le client initie **toutes les connexions** (commande + donnÃ©es), ce qui fonctionne derriÃ¨re NAT.

---

Parfait, tu passes maintenant Ã  la configuration **DHCP** pour automatiser lâ€™attribution des adresses IP et des paramÃ¨tres rÃ©seau ğŸ‘‡  

---

### âš™ï¸ Exercice 3.15 â€“ Installer et configurer le serveur DHCP sur le routeur
1. **Installer le paquet DHCP** (sur Gentoo, par exemple `net-misc/dhcp` ou `net-misc/dhcpd`) :  
   ```bash
   emerge --ask net-misc/dhcp
   ```

2. **Ã‰diter le fichier de configuration** `/etc/dhcp/dhcpd.conf` :  
   Exemple minimal adaptÃ© Ã  ton TP :
   ```conf
   default-lease-time 600;
   max-lease-time 7200;

   option domain-name "istycorp.fr";
   option domain-name-servers 193.55.xx.xx;   # Remplace par le DNS de lâ€™universitÃ© trouvÃ© dans /etc/resolv.conf

   subnet 192.168.0.0 netmask 255.255.255.0 {
       range 192.168.0.2 192.168.0.10;
       option routers 192.168.0.1;
       option broadcast-address 192.168.0.255;
   }
   ```

   ğŸ‘‰ Ce fichier dÃ©finit :
   - La **plage dâ€™IP** attribuÃ©es automatiquement (192.168.0.2 â†’ 192.168.0.10).  
   - Le **masque** (255.255.255.0).  
   - La **passerelle par dÃ©faut** (192.168.0.1).  
   - Le **domaine local** (istycorp.fr).  
   - Le **DNS** (celui de lâ€™universitÃ©, rÃ©cupÃ©rÃ© dans `/etc/resolv.conf`).  

3. **Lancer le service DHCP** :  
   ```bash
   rc-update add dhcpd default
   /etc/init.d/dhcpd start
   ```

---

### ğŸ–¥ï¸ Exercice 3.16 â€“ Validation cÃ´tÃ© client
1. Sur **client1**, assure-toi que lâ€™interface rÃ©seau est configurÃ©e en mode DHCP (pas dâ€™IP statique).  
   Tu peux relancer le service rÃ©seau ou simplement redÃ©marrer la VM.  

2. VÃ©rifie lâ€™attribution automatique :  
   ```bash
   ifconfig eth0
   ```
   ğŸ‘‰ Tu devrais voir une IP entre `192.168.0.2` et `192.168.0.10`.

3. VÃ©rifie la passerelle et le DNS :  
   ```bash
   route -n
   cat /etc/resolv.conf
   ```
   ğŸ‘‰ La passerelle doit Ãªtre `192.168.0.1` et le DNS celui de lâ€™universitÃ©.

4. Teste la connectivitÃ© :  
   ```bash
   ping 8.8.8.8
   ping google.com
   ```
   Si les deux fonctionnent, ton DHCP + NAT + DNS sont opÃ©rationnels ğŸ‰.

---

Parfait, tu arrives Ã  la partie **cache DNS et services bonus**. Je vais dÃ©tailler chaque exercice ğŸ‘‡  

---

### ğŸ§© Exercice 3.17 â€“ Installer et configurer dnsmasq
1. **Installer dnsmasq** sur le routeur :  
   ```bash
   emerge --ask net-dns/dnsmasq
   ```
2. **Configurer dnsmasq** dans `/etc/dnsmasq.conf` :  
   Exemple minimal :
   ```conf
   domain-needed
   bogus-priv
   no-resolv
   server=193.55.xx.xx   # DNS de lâ€™universitÃ©
   listen-address=127.0.0.1,192.168.0.1
   ```
   ğŸ‘‰ Cela fait du routeur un cache DNS, intercalÃ© entre le client et Internet.  
3. **Configurer le client** pour utiliser le routeur comme DNS :  
   Dans `/etc/resolv.conf` du client :
   ```conf
   nameserver 192.168.0.1
   ```

---

### ğŸ“‘ Exercice 3.18 â€“ RÃ©solutions internes via `/etc/hosts`
Sur le routeur, Ã©dite `/etc/hosts` :
```conf
192.168.0.1 router.istycorp.fr router
192.168.0.2 client1.istycorp.fr client1
```
ğŸ‘‰ dnsmasq utilisera ces entrÃ©es locales.  
Teste depuis le client :
```bash
ping client1.istycorp.fr
ping router.istycorp.fr
```
Tu verras que la rÃ©solution passe par le cache DNS du routeur.

---

### âš ï¸ Exercice 3.19 â€“ Ã‰craser une rÃ©solution
Ajoute dans `/etc/hosts` du routeur :
```conf
192.168.0.1 google.com
```
ğŸ‘‰ Le client sera redirigÃ© vers le routeur lorsquâ€™il demande `google.com`.  
**Remarque sÃ©curitÃ©** :  
- Sur un rÃ©seau dont tu nâ€™es pas maÃ®tre, un administrateur malveillant peut dÃ©tourner les rÃ©solutions DNS (DNS spoofing).  
- Cela permet de rediriger vers de faux sites (phishing, vol de donnÃ©es).  
- **Solution** : utiliser des connexions sÃ©curisÃ©es (HTTPS/TLS) et vÃ©rifier les certificats. Le chiffrement garantit que mÃªme si la rÃ©solution est dÃ©tournÃ©e, la connexion Ã©chouera si le certificat nâ€™est pas valide.

---

### ğŸ“‚ Exercice 3.20 â€“ Serveur NFS
1. **Installer NFS sur le routeur** :  
   ```bash
   emerge --ask net-fs/nfs-utils
   ```
2. **Configurer lâ€™export** dans `/etc/exports` :  
   ```conf
   /home *(rw,sync,no_root_squash)
   ```
3. **DÃ©marrer NFS** :  
   ```bash
   /etc/init.d/nfs start
   ```
4. **Monter sur le client** :  
   ```bash
   mount -t nfs 192.168.0.1:/home /mnt/home
   ```

---

### ğŸ”’ Exercice 3.21 â€“ SÃ©curitÃ© des droits utilisateurs
- Les droits Unix (lecture/Ã©criture/exÃ©cution) sont respectÃ©s par NFS.  
- Mais attention : si le client est compromis, il peut usurper des UID/GID â†’ les restrictions ne sont pas toujours fiables.  
- **Bonne pratique** : utiliser `root_squash`, Kerberos ou un systÃ¨me dâ€™authentification fort pour Ã©viter les abus.

---

### ğŸ”‘ Bonus â€“ Redirection SSH
1. Installe SSH sur le client :
   ```bash
   emerge --ask net-misc/openssh
   /etc/init.d/sshd start
   ```
2. Sur le routeur, ajoute une rÃ¨gle de redirection NAT :  
   ```bash
   iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 2223 -j DNAT --to-destination 192.168.0.2:22
   ```
3. Sur la machine hÃ´te (VirtualBox), configure une redirection du port `2223` vers le routeur.  
4. Tu pourras te connecter ainsi :
   ```bash
   ssh -p 2223 user@localhost
   ```

---

