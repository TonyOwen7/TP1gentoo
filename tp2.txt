Parfaitâ€¯! Voici une **checklist complÃ¨te pour TP2 Gentoo OpenRC** avec toutes les commandes concrÃ¨tes pour compiler le noyau, installer GRUB et finaliser le systÃ¨meâ€¯:

---

## **1ï¸âƒ£ Installer les sources du noyau**

Si RAM limitÃ©eâ€¯: tÃ©lÃ©charger depuis kernel.org

```bash
cd /usr/src
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.10.tar.xz
tar xf linux-6.6.10.tar.xz
ln -s linux-6.6.10 linux
cd linux
```

Sinon, avec emergeâ€¯:

```bash
emerge --noreplace sys-kernel/gentoo-sources
cd /usr/src/linux
```

---

## **2ï¸âƒ£ Identifier le matÃ©riel**

```bash
lspci           # pÃ©riphÃ©riques PCI (chipset, carte graphique)
lsusb           # pÃ©riphÃ©riques USB
dmesg | less    # messages du noyau
lshw            # configuration dÃ©taillÃ©e
```

> Note ce dont tu as besoin pour activer dans le noyau.

---

## **3ï¸âƒ£ Configurer le noyau**

```bash
make menuconfig    # interface de configuration du noyau
```

Points Ã  vÃ©rifier/modifier :

* **Filesystems** â†’ activer les systÃ¨mes de fichiers utilisÃ©s
* **Device Drivers â†’ Generic Driver Options â†’ Devtmpfs** â†’ activer
* DÃ©sactiverâ€¯:

  * Debugging options
  * Support Wi-Fi
  * Support Mac

Sauvegarder la configuration.

---

## **4ï¸âƒ£ Compiler et installer le noyau**

```bash
make -j$(nproc)          # compiler le noyau
make modules_install      # installer les modules
make install              # installer vmlinuz, System.map et config
```

---

## **5ï¸âƒ£ Installer GRUB2 et gÃ©nÃ©rer grub.cfg**

### VÃ©rifier que grub est installÃ©

```bash
emerge --noreplace sys-boot/grub
```

### Installer GRUB dans le MBR

```bash
grub-install /dev/sda
grub-mkconfig -o /boot/grub/grub.cfg
```

> `/dev/sda` est le disque principalâ€¯; ne pas mettre la partition (`/dev/sda1`) pour le BIOS.

---

## **6ï¸âƒ£ Configurer root et logs**

```bash
passwd             # dÃ©finir le mot de passe root
emerge --noreplace syslog-ng logrotate
rc-update add syslog-ng default
```

---

## **7ï¸ Finaliser et redÃ©marrer**

```bash
exit                           # sortir du chroot
umount -R /mnt/gentoo          # dÃ©monter toutes les partitions
swapoff /dev/sda2               # dÃ©sactiver la swap
reboot
```

Voici un rÃ©sumÃ© dÃ©taillÃ© en franÃ§ais avec les commandes Ã  utiliser pour ces exercices sous Gentoo/OpenRC :

---

### **Exercice 2.8 â€“ CrÃ©ation dâ€™un utilisateur avec droits dâ€™administration**

1. CrÃ©e un utilisateur `Tony` (remplace par ton nom si nÃ©cessaire) :

```bash
useradd -m -G users,wheel -s /bin/bash Tony
```

2. DÃ©fini un mot de passe pour cet utilisateur :

```bash
passwd Tony
```

3. Installer `sudo` si ce nâ€™est pas dÃ©jÃ  fait :

```bash
emerge --noreplace sudo
```

4. Ã‰diter le fichier sudoers pour permettre aux utilisateurs du groupe `wheel` dâ€™utiliser sudo :

```bash
EDITOR=nano visudo
```

* DÃ©commenter ou ajouter la ligne :

```
%wheel ALL=(ALL) ALL
```

5. VÃ©rifie que Tony peut exÃ©cuter des commandes en root :

```bash
su - Tony
sudo whoami
```

> La sortie doit Ãªtre `root`.

---

### **Exercice 2.9 â€“ Activer les quotas pour Tony**

1. Modifier `/etc/fstab` pour activer les quotas sur la partition root (ou celle dÃ©sirÃ©e) :

```
LABEL=root / ext4 defaults,usrquota,grpquota 0 1
```

2. Remonter la partition avec quotas :

```bash
mount -o remount /
```

3. CrÃ©er les fichiers de quotas et gÃ©nÃ©rer la base :

```bash
quotacheck -cum /
quotaon -v /
```

4. Limiter Tony Ã  200â€¯Mo :

```bash
edquota -u Tony
```

* Dans lâ€™Ã©diteur, mettre `200M` pour soft et hard limit sur `blocks`.

5. Tester la limite :

```bash
su - Tony
dd if=/dev/zero of=test.txt bs=1M count=300
```

> Tu dois obtenir une erreur de dÃ©passement de quota.

---

### **AccÃ¨s distant SSH**

1. Installer OpenSSH :

```bash
emerge --noreplace openssh
```

2. Activer SSH au dÃ©marrage (OpenRC) :

```bash
rc-update add sshd default
```

3. DÃ©marrer le service immÃ©diatement :

```bash
/etc/init.d/sshd start
```

4. Configurer la VM pour rediriger le port local 2222 vers le port 22 de la VM.

5. Test de connexion depuis lâ€™hÃ´te :

```bash
ssh -p 2222 Tony@localhost
```

---

### **Exercice 2.10 â€“ Installer hwloc dans le home de Tony**

1. TÃ©lÃ©charger et extraire hwloc dans `/home/Tony/usr` :

```bash
su - Tony
mkdir -p ~/usr
cd ~/usr
wget https://www.open-mpi.org/software/hwloc/v2.11/hwloc-2.11.2.tar.gz
tar xzf hwloc-2.11.2.tar.gz
cd hwloc-2.11.2
./configure --prefix=$HOME/usr
make
make install
```

---

### **Exercice 2.11 â€“ Configurer lâ€™environnement pour hwloc**

1. Ajouter le chemin `~/usr/bin` Ã  la variable PATH dans `.bashrc` ou `.profile` :

```bash
echo 'export PATH=$HOME/usr/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
```

2. Tester la commande :

```bash
hwloc-ls
```

> La commande doit fonctionner sans indiquer le chemin complet.

---

TrÃ¨s bien â€” je vais te faire un **TP complet, clair et opÃ©rationnel**, qui rÃ©unit **tous les exercices (2.12 â†’ 2.15)**, avec **les commandes + explications**.
Tu pourras suivre Ã©tape par Ã©tape et vÃ©rifier Ã  chaque point que tu es sur la bonne trajectoire.
Je le formule comme un guide pÃ©dagogique, pas comme un script automatique.

---

# ğŸ§© **TP LVM /home â€” version complÃ¨te et expliquÃ©e**

---

# **ğŸ“˜ Exercice 2.12 â€” Comprendre comment agrandir une partition**

## ğŸ‘‰ **Cas 1 : agrandir /home qui est en LVM**

Si `/home` est dÃ©jÃ  sous LVM, le plan est simple :

1. Ajouter un disque (ou utiliser un espace libre)
2. Mettre une nouvelle partition en *physical volume*

   ```bash
   pvcreate /dev/sdb1
   ```
3. L'ajouter au *volume group*

   ```bash
   vgextend vg_home /dev/sdb1
   ```
4. Ã‰tendre le *logical volume*

   ```bash
   lvextend -l +100%FREE /dev/vg_home/home
   ```
5. Agrandir le systÃ¨me de fichiers

   ```bash
   resize2fs /dev/vg_home/home
   ```

### ğŸ¯ RÃ©sultat : `/home` gagne de lâ€™espace sans redÃ©marrage.

---

## ğŸ‘‰ **Cas 2 : agrandir /**

Beaucoup plus dÃ©licat, car `/` est souvent non LVM.
Solution :

* DÃ©marrer sur live CD
* Faire des copies avec `rsync`
* RecrÃ©er `/` sous LVM
* Restaurer

Dans la pratique : Ã©vitÃ© en production quand possible.

---

# **ğŸ“˜ Exercice 2.13 â€” Convertir /home en LVM**

Ici tu lâ€™as fait, mais je rÃ©capitule proprement.

---

## ğŸ’ **1. Faire une archive de /home**

Depuis `/` ou ailleurs (pas Ã  lâ€™intÃ©rieur de /home !) :

```bash
cd /
sudo tar czpf /root/home_backup.tar.gz home
```

**Pourquoi ces options ?**

* **c** â†’ create
* **z** â†’ gzip
* **p** â†’ preserve permissions
* **f** â†’ filename
* **home** â†’ le dossier Ã  archiver

ğŸ“¦ Tu obtiens `/root/home_backup.tar.gz` contenant tout /home + permissions + attributs.

---

## ğŸ”¥ **2. Supprimer lâ€™ancienne partition /home**

DÃ©monter /home :

```bash
sudo umount /home
```

VÃ©rifier :

```bash
mount | grep home
```

Depuis `fdisk` ou `cfdisk`, efface `/dev/sda4` (ou autre partition /home).

---

## ğŸ§± **3. CrÃ©er LVM**

CrÃ©er un PV :

```bash
sudo pvcreate /dev/sda4
```

CrÃ©er un VG :

```bash
sudo vgcreate vg_home /dev/sda4
```

CrÃ©er un LV pour /home :

```bash
sudo lvcreate -l 100%FREE -n home vg_home
```

Formatage :

```bash
sudo mkfs.ext4 /dev/vg_home/home
```

---

## ğŸ—„ï¸ **4. Monter et restaurer**

CrÃ©er point de montage :

```bash
sudo mount /dev/vg_home/home /home
```

Restaurer lâ€™archive :

```bash
cd /
sudo tar xzpf /root/home_backup.tar.gz
```

VÃ©rifier :

```bash
ls -l /home
```

---

## ğŸ“ **5. Mise Ã  jour de /etc/fstab**

Tu dois avoir *seulement* :

```
/dev/vg_home/home   /home   ext4   noatime,usrquota,grpquota   0 2
```

Supprime ou commente la ligne `/dev/sda4`.

---

# **ğŸ“˜ Exercice 2.14 â€” Extension de /home avec un nouveau disque**

Disons que tu ajoutes **/dev/sdb** de 10 Go.

---

## âš™ï¸ **1. CrÃ©ation de partition**

```bash
sudo cfdisk /dev/sdb
```

CrÃ©er :

* 1 partition Linux (`/dev/sdb1`)
* Type â€œLinux filesystemâ€

---

## ğŸ”‹ **2. Convertir en physical volume**

```bash
sudo pvcreate /dev/sdb1
```

VÃ©rifier :

```bash
sudo pvs
```

---

## ğŸ§© **3. Ã‰tendue du volume group**

```bash
sudo vgextend vg_home /dev/sdb1
```

VÃ©rifier :

```bash
sudo vgs
```

Tu dois voir **vg_home** avec plus dâ€™espace.

---

## ğŸ“ **4. Ã‰tendre le logical volume**

```bash
sudo lvextend -l +100%FREE /dev/vg_home/home
```

---

## ğŸŒ± **5. Agrandir le systÃ¨me de fichier ext4**

```bash
sudo resize2fs /dev/vg_home/home
```

VÃ©rifie la nouvelle taille :

```bash
df -h | grep home
```

ğŸ‰ `/home` est maintenant plus grand.

---

# **ğŸ“˜ Exercice 2.15 â€” Quel danger avec disques physiques ?**

Si tu Ã©tends LVM sur **plusieurs disques physiques**, ton volume devient :

ğŸŒ *un grand lac posÃ© sur plusieurs roches*

Si **un seul disque meurt â†’ tout LVM meurt** (donnÃ©es de /home incluses).
Câ€™est similaire Ã  du RAID0, mais **sans sÃ©curitÃ©**.

ğŸ‘‰ **Donc : importante vulnÃ©rabilitÃ© : un disque perdu = donnÃ©es perdues.**
ğŸ‘‰ Solution rÃ©aliste : RAID1/5/6/10 sous LVM.

